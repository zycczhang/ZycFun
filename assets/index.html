<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV 遥控端</title>
    <style>
        body { background-color: #121212; color: #fff; font-family: sans-serif; margin: 0; padding-bottom: 60px; }
        .nav { position: fixed; bottom: 0; width: 100%; display: flex; background: #1E1E1E; border-top: 1px solid #333; }
        .nav-item { flex: 1; padding: 15px; text-align: center; color: #888; cursor: pointer; }
        .nav-item.active { color: orange; font-weight: bold; }

        .page { display: none; padding: 20px; }
        .page.active { display: block; }

        .input-group { display: flex; margin-bottom: 20px; }
        input { flex: 1; padding: 10px; border-radius: 4px; border: none; background: #333; color: white; outline: none;}
        button { padding: 10px 20px; background: orange; border: none; border-radius: 4px; color: black; font-weight: bold; margin-left: 10px; cursor: pointer;}

        .card { background: #1E1E1E; margin-bottom: 10px; padding: 10px; border-radius: 8px; display: flex; align-items: center; }
        .card img { width: 60px; height: 80px; object-fit: cover; border-radius: 4px; margin-right: 15px; }
        .card-info { flex: 1; }
        .card-title { font-weight: bold; margin-bottom: 5px; font-size: 16px; }
        .card-note { color: #888; font-size: 12px; }
        .card-actions { display: flex; gap: 10px; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-fav { background: transparent; border: 1px solid orange; color: orange; }
        .btn-fav.is-fav { background: orange; color: black; border: 1px solid orange; }

        /* 新增：日志区域样式 */
        #log-container {
            background: #000;
            color: #0f0; /* 绿色字体，像黑客终端 */
            font-family: monospace;
            padding: 10px;
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 12px;
            white-space: pre-wrap; /* 自动换行 */
        }
    </style>
</head>
<body>

<div id="search-page" class="page active">
    <h2>搜索</h2>
    <div class="input-group">
        <input type="text" id="search-input" placeholder="输入番剧名称...">
        <button onclick="doSearch()">搜索</button>
    </div>
    <div id="search-results"></div>
</div>

<div id="fav-page" class="page">
    <h2>我的收藏</h2>
    <div id="fav-list">加载中...</div>
</div>

<!-- 修改：设置页面增加日志显示 -->
<div id="setting-page" class="page">
    <h2>设置</h2>
    <p>当前线路地址:</p>
    <div class="input-group">
        <input type="text" id="base-url-input">
        <button onclick="saveBaseUrl()">保存</button>
    </div>
    <button onclick="location.reload()" class="btn-fav" style="width:100%; margin-top:10px;">刷新网页</button>

    <hr style="border-color: #333; margin: 20px 0;">

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3>App 实时日志</h3>
        <div>
            <span id="log-status" style="font-size:12px; color:#888;"></span>
            <button class="btn-sm" onclick="clearLogs()">清空</button>
        </div>
    </div>
    <div id="log-container">等待连接...</div>
</div>

<div class="nav">
    <div class="nav-item active" onclick="switchTab('search')">搜索</div>
    <div class="nav-item" onclick="switchTab('fav')">收藏</div>
    <div class="nav-item" onclick="switchTab('setting')">设置/日志</div>
</div>

<script>
    const baseUrl = "";
    let logInterval = null; // 日志轮询定时器

    function switchTab(tab) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

        document.getElementById(tab + '-page').classList.add('active');
        const items = document.querySelectorAll('.nav-item');
        if(tab === 'search') items[0].classList.add('active');
        if(tab === 'fav') items[1].classList.add('active');
        if(tab === 'setting') items[2].classList.add('active');

        if (tab === 'fav') loadFavorites();
        if (tab === 'setting') {
            loadSettings();
            startLogPolling(); // 进入设置页开始轮询日志
        } else {
            stopLogPolling(); // 离开设置页停止轮询以节省资源
        }
    }

    // --- 日志相关逻辑 ---
    function startLogPolling() {
        if(logInterval) return;
        fetchLogs(); // 立即执行一次
        logInterval = setInterval(fetchLogs, 1000); // 每秒拉取一次
        document.getElementById('log-status').innerText = '• 实时更新中';
    }

    function stopLogPolling() {
        if(logInterval) {
            clearInterval(logInterval);
            logInterval = null;
            document.getElementById('log-status').innerText = '';
        }
    }

    async function fetchLogs() {
        try {
            const res = await fetch(`${baseUrl}/api/logs`);
            const logs = await res.json();
            const container = document.getElementById('log-container');

            if(logs.length > 0) {
                // 将日志数组连接成字符串
                container.innerText = logs.join('\n');
                // 自动滚动到底部
                container.scrollTop = container.scrollHeight;
            } else {
                container.innerText = "暂无日志...";
            }
        } catch(e) {
            console.error("日志获取失败", e);
        }
    }

    async function clearLogs() {
        await fetch(`${baseUrl}/api/logs/clear`, { method: 'POST' });
        document.getElementById('log-container').innerText = "";
    }
    // ------------------

    async function doSearch() {
        const val = document.getElementById('search-input').value;
        if(!val) return;
        const container = document.getElementById('search-results');
        container.innerHTML = '<div style="text-align:center;color:#888">搜索中...</div>';

        try {
            const res = await fetch(`${baseUrl}/api/search/${encodeURIComponent(val)}`);
            const data = await res.json();
            renderList('search-results', data);
        } catch(e) {
            container.innerText = '搜索失败';
        }
    }

    async function loadFavorites() {
        const res = await fetch(`${baseUrl}/api/favorites`);
        const data = await res.json();
        renderList('fav-list', data);
    }

    async function loadSettings() {
        try {
            const res = await fetch(`${baseUrl}/api/baseurl`);
            const data = await res.json();
            document.getElementById('base-url-input').value = data.url;
        } catch(e) {}
    }

    async function saveBaseUrl() {
        const url = document.getElementById('base-url-input').value;
        await fetch(`${baseUrl}/api/baseurl`, {
            method: 'POST',
            body: JSON.stringify({url: url})
        });
        alert('已保存，TV端将更新');
    }

    function renderList(containerId, list) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if(list.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:#666">暂无数据</div>';
            return;
        }

        list.forEach(item => {
            const isFav = item.isFavorite === true;
            const btnText = isFav ? '已收藏' : '收藏';
            const btnClass = isFav ? 'btn-fav is-fav' : 'btn-fav';
            const div = document.createElement('div');
            div.className = 'card';
            const itemJson = JSON.stringify(item).replace(/'/g, "&apos;");

            div.innerHTML = `
                <img src="${item.imageUrl}" onerror="this.src='https://via.placeholder.com/60x80'">
                <div class="card-info">
                    <div class="card-title">${item.title}</div>
                    <div class="card-note">${item.note || ''}</div>
                </div>
                <div class="card-actions">
                    <button class="btn-sm" onclick='playOnTv(${itemJson})'>播放</button>
                    <button class="btn-sm ${btnClass}" onclick='toggleFav(this, ${itemJson})'>${btnText}</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    async function playOnTv(item) {
        if(confirm("确定要在电视上播放《" + item.title + "》吗？")) {
            await fetch(`${baseUrl}/api/play`, {
                method: 'POST',
                body: JSON.stringify({url: item.url})
            });
        }
    }

    async function toggleFav(btnElement, item) {
        const isCurrentlyFav = btnElement.classList.contains('is-fav');
        if (isCurrentlyFav) {
            btnElement.classList.remove('is-fav');
            btnElement.innerText = '收藏';
        } else {
            btnElement.classList.add('is-fav');
            btnElement.innerText = '已收藏';
        }
        try {
            await fetch(`${baseUrl}/api/favorite/toggle`, {
                method: 'POST',
                body: JSON.stringify(item)
            });
        } catch (e) {
            alert('操作失败');
        }
    }
</script>
</body>
</html>